var MidiPiano=MidiPiano||{};!function(e,a){"use strict";function t(){MIDI.programChange(4,MIDI.GM.byName.acoustic_grand_piano.number),MIDI.programChange(3,MIDI.GM.byName.acoustic_grand_piano.number),MIDI.programChange(2,MIDI.GM.byName.acoustic_grand_piano.number),MIDI.programChange(1,MIDI.GM.byName.acoustic_grand_piano.number)}function o(e){x=e?e.displayName+"-"+Math.random().toString(36).substr(2,9):"altspaceUser-"+Math.random().toString(36).substr(2,9),B=Please.make_color({golden:!1,saturation:1,value:1})[0],_=new THREE.Color(B)}function i(e){G=1==e.innerDepth?e.pixelsPerMeter/285.714294*3:e.pixelsPerMeter/285.714294*3,L=L*G/3,A=A*G/3,k=k*G/3,N=79*G,z=z*G/3,U=1.5*G}function n(){if(t(),altspace.inClient){var e=[a.getUser(),a.getSpace(),a.getEnclosure()];Promise.all(e).then(function(e){var t=e.shift();o(t);var n=e.shift();W=n.sid,D=n.name;var r=e.shift();i(r),console.log("Connecting to Firebase....");var l={appId:"Midi Piano",instanceId:W,authorId:"NorybiaK",baseRefUrl:"midi-piano.firebaseio.com"};a.utilities.sync.connect(l).then(function(e){altspace.getThreeJSTrackingSkeleton().then(function(a){g=a,I.add(g),console.log("Connected to Firebase!"),R=e.instance.child("data"),H=e.instance.child("users"),R.child("name").set(D),console.log("Initalizing Piano...."),s()})})})}}function r(){MIDI.loadPlugin({soundfontUrl:"assets/soundfont/",targetFormat:"ogg",instruments:"acoustic_grand_piano",onsuccess:n})}function s(){for(var e=0;e<7;++e){var a=12*e;l(a+0,"W","B"),l(a+1,"B","W"),l(a+2,"W","B"),l(a+3,"W","W"),l(a+4,"B","W"),l(a+5,"W","B"),l(a+6,"B","W"),l(a+7,"W","B"),l(a+8,"W","W"),l(a+9,"B","W"),l(a+10,"W","B"),l(a+11,"B","W")}l(84,"W","B"),l(85,"B","W"),l(86,"W","B"),l(87,"W","W"),MIDI.Player.addListener(function(e){var a=(e.channel,e.velocity),t=(e.message,e.note-21);144==e.message?0==a?"B"==b[t]?P[t].material.color=S:P[t].material.color=F:P[t].material.color=C:"B"==b[t]?P[t].material.color=S:P[t].material.color=F,P[t].material.needsUpdate=!0}),UltimateLoader.load("assets/model/piano.obj",function(a){T=a,T.scale.set(G,G,G),j.add(T),j.position.set(w.x,w.y,w.z),j.rotation.x=w.x*(Math.PI/180),j.rotation.y=w.y*(Math.PI/180),j.rotation.z=w.z*(Math.PI/180),I.add(j);var t=c("Play me!",0,125,67,-18,50);T.add(t);var o=c("MIDI Keyboard?",0,118,69,-18,50);T.add(o);var i=c("Visit - norybiak.com/apps/piano -",0,114,70,-18,50);T.add(i);var n=new THREE.MTLLoader.MaterialCreator;n.crossOrigin="anonymous";var r="assets/textures/wood.jpg",s=n.loadTexture(r),l=new THREE.MeshBasicMaterial({color:"#FFFFFF",map:s}),u=new THREE.BoxGeometry(7,5,30),f=new THREE.Mesh(u,l);f.scale.set(1,1,1),f.position.set(-75.9,79.5,83),T.add(f);var h=new THREE.Mesh(u,l);for(h.scale.set(1,1,1),h.position.set(77.3,79.5,83),T.add(h),d(),e=0;e<ee.length;e++)ee[e].text=c(ee[e].title,0,100,80.5,0,50),T.add(ee[e].text),ee[e].text.visible=!1;animate(),p(),console.log("Piano initalized!")})}function l(e,a,t){if("W"==a){k+="W"==t?L:A;var o=new THREE.BoxGeometry(2.68,5.83,17.5);o.translate(0,0,8.75);var i=new THREE.MTLLoader.MaterialCreator;i.crossOrigin="anonymous";var n="assets/textures/keyShadow.png",r=i.loadTexture(n),s=new THREE.MeshBasicMaterial({color:"#FFFFFF",map:r});P[e]=new THREE.Mesh(o,s),P[e].scale.set(G,G,G),P[e].position.set(k,N,z)}else if("B"==a){k+=A;var o=new THREE.BoxGeometry(1.52,6.07,12.83),s=new THREE.MeshBasicMaterial({color:"#000000"});o.translate(0,0,6.415),P[e]=new THREE.Mesh(o,s),P[e].scale.set(G,G,G),P[e].position.set(k,N+U,z)}b[e]=a,P[e].addBehavior(altspace.utilities.behaviors.JointCollisionEvents({joints:[["Index","Right",3],["Index","Left",3]],jointCubeSize:.1})),P[e].addEventListener("jointcollisionenter",function(a){J||(f(e+21,127),H.child(x).child("notes").child(e+21).set([Math.random(),127]),setTimeout(function(){h(e+21,0),H.child(x).child("notes").child(e+21).set([0,127])},300))}),P[e].addEventListener("cursordown",function(){J||(f(e+21,127),H.child(x).child("notes").child(e+21).set([Math.random(),127]),setTimeout(function(){h(e+21,0),H.child(x).child("notes").child(e+21).set([0,127])},300))}),j.add(P[e])}function d(){var e,a=new THREE.MTLLoader.MaterialCreator;a.crossOrigin="anonymous";var t="assets/textures/buttonShadow.png",o=a.loadTexture(t);e=new THREE.BoxGeometry(3,3,3);var i=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:"#00ff00",map:o}));i.scale.set(1,1,1),i.position.set(0,5,0),V.add(i),i.addEventListener("cursordown",function(e){MIDI.Player.playing||(R.update({startTime:Firebase.ServerValue.TIMESTAMP}),R.update({userStarted:x}),R.update({playing:1}))});var n=c("Play",5,-1.5,.5,0,25);n.x=5,i.add(n),e=new THREE.BoxGeometry(3,3,3);var r=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:"#f0ff00",map:o}));r.scale.set(1,1,1),r.position.set(0,0,0),V.add(r),r.addEventListener("cursorup",function(e){Q++,R.update({playing:0,song:Q})});var s=c("Next",5,-1.5,.5,0,25);r.add(s),e=new THREE.BoxGeometry(3,3,3);var l=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:"#FF0000",map:o}));l.scale.set(1,1,1),l.position.set(0,-5,0),V.add(l),l.addEventListener("cursorup",function(e){R.update({playing:0})});var d=c("Stop",5,-1.5,.5,0,25);l.add(d),V.position.set(-66,95,80),T.add(V),e=new THREE.BoxGeometry(3,3,3);var u=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:"#f0ff00",map:o}));u.scale.set(1,1,1),u.position.set(-70,0,0),K.add(u);var p=c("Mute",0,3,.5,0,25),f=c("Unmute",0,3,.5,0,25);f.visible=!1,u.add(p),u.add(f),u.addEventListener("cursorup",function(e){p.visible=!p.visible,f.visible=!f.visible,J=!J,m(J?0:X)}),e=new THREE.BoxGeometry(10,1,0);var h=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:"#9f9f9f",map:o}));h.scale.set(1,1,1),h.position.set(-55,-1,0),h.visible=!1,K.add(h);var E=c("Vol",0,-4.5,.5,0,25);h.add(E);for(var v=0;v<5;v++)e=new THREE.BoxGeometry(.8,v+1,2),O[v]=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:"#f0ff00",map:o})),O[v].scale.set(2,2,2),O[v].position.set(-4.2+2*v,-.5+(v+1),-.5),h.add(O[v]),O[v].addEventListener("cursorup",function(e){for(var a=!1,t=0;t<5;t++)e.target==O[t]?(O[t].material.color=Z,X=t+1,m(X),a=!0):a?O[t].material.color=Y:O[t].material.color=Z});K.position.set(120,95,80),K.scale.set(1,1,1),T.add(K)}function c(e,a,t,o,i,n){var r={text:e,fontSize:n},s=E(r);return s.position.set(a,t,o+1),s.rotateX(i*Math.PI/180),s}function u(e,a){e.visible=a}function p(){function e(){a.on("value",function(e){var a=e.val();1==a?(H.child(x).child("control").update({joinTime:Firebase.ServerValue.TIMESTAMP}),R.child("startTime").once("value",function(e){var a=e.val();H.child(x).child("control").child("joinTime").once("value",function(e){var t=e.val(),o=t-a;o>MIDI.Player.endTime?R.update({playing:0}):(MIDI.Player.currentTime=o,MIDI.Player.start())})})):(MIDI.Player.stop(),R.update({startTime:0}))})}R.once("value",function(e){var a=e.exists();a||R.set({playing:0,song:0})}),H.child(x).child("settings").set({color:B}),H.on("child_added",function(e,a){var t=e.key(),o=H.child(t);t!=x&&(console.log("New user joined: "+t),o.child("settings").child("color").once("value",function(e){var a=e.val();a||(a=Please.make_color({golden:!1,saturation:1,value:1})[0]),q[t]=new THREE.Color(a),console.log("User "+t+"'s color is set to "+e.val())}),o.child("notes").on("child_added",function(e){var a=e.key();e.val();o.child("notes").child(a).on("value",function(e){var o=e.val();if(o){var i=o[0],n=o[1];0==i?h(a,n):f(a,n,t)}})}))}),H.child(x).onDisconnect().remove(),H.on("child_removed",function(e){var a=e.key(),t=H.child(a);t.child("on").off("value"),t.child("off").off("value"),delete q[a],console.log("User "+e.key()+" has left.")});var a=R.child("playing"),t=R.child("song");R.child("currentTime");t.on("value",function(a){var t=a.val();Q=t>ee.length-1?0:t,$?(MIDI.Player.timeWarp=ee[Q].speed,MIDI.Player.loadFile("assets/songs/"+ee[Q].file,function(){console.log(ee[Q].title+"  loaded!"),e(),$=!1})):(MIDI.Player.timeWarp=ee[Q].speed,MIDI.Player.loadFile("assets/songs/"+ee[Q].file,function(){console.log(ee[Q].title+"  loaded!")})),u(ee[t-1].text,!1),u(ee[Q].text,!0),console.log("current song:"+Q)}),console.log("Firebase functions initalized!")}function f(e,a,t){if(t=t||!1,J||MIDI.noteOn(0,e,a),0==P[e-21].rotation.x)if("B"==b[e-21]){new TWEEN.Tween(P[e-21].rotation).to({x:P[e-21].rotation.x+.02*Math.PI},.1).start()}else{new TWEEN.Tween(P[e-21].rotation).to({x:P[e-21].rotation.x+.04*Math.PI},.1).start()}t?P[e-21].material.color=q[t]:P[e-21].material.color=_}function h(e,a,t){J||MIDI.noteOff(0,e,a);new TWEEN.Tween(P[e-21].rotation).to({x:0},.1).start();"B"==b[e-21]?P[e-21].material.color=S:P[e-21].material.color=F}function m(e){var a=25.4*e;MIDI.setVolume(0,a),console.log(e+" "+a)}function E(e){var a=v("n-text");return M(a,"n-text",e),a}function v(e){var a=new THREE.BoxGeometry(.001,.001,.001),t=new THREE.MeshBasicMaterial({color:0});t.visible=!1;var o=new THREE.Mesh(a,t);return I.add(o),altspace.addNativeComponent(o,e),o}function M(e,a,t){var o=ae["n-text"];for(var i in t)o[i]=t[i];altspace.updateNativeComponent(e,a,o)}var g,T,w,y,I,R,H,x,B,_,P=[],b=[],D="",W="",C=new THREE.Color(16711680),F=new THREE.Color(16777215),S=new THREE.Color(0),k=-217,N=-270,z=240,G=3,L=8.5,A=4.2,U=3,j=new THREE.Group,O=[],K=new THREE.Group,V=new THREE.Group,J=!1,X=5,Y=new THREE.Color(10461087),Z=new THREE.Color(15793920),q={},Q=0,$=!0,ee=[{file:"mozart_sonata_2-pianos_375_1_(c)ishenko.mid",title:"Sonata in D major, for two - Mozart",speed:1},{file:"517-Scarlatti.mid",title:"Sonata in D minor, K. 517 - Scarlatti",speed:.5},{file:"HungarianRhapsodyNo10S24410.mid",title:"Hungarian Rhapsody No. 10, S. 244/10",speed:1},{file:"Roslin_Adama.mid",title:"Roslin & Adama - Bear McCreary",speed:1},{file:"ParagonX9_Chaoz_Fantasy.mid",title:"Chaoz Fantasy - ParagonX9",speed:1},{file:"swordland_1.mid",title:"Swordland (SAO) - Yuki Kajiura",speed:1},{file:"9725s_maple_leaf_rag_(nc)smythe.mid",title:"Maple Leaf - Scott Joplin",speed:1},{file:"hes_a_pirate.mid",title:"He's a Pirate - Klaus Badelt",speed:1},{file:"touhou.mid",title:"U.N. Owen Was Her? - ZUN",speed:1},{file:"cruel_angel.mid",title:"Cruel Angel - Neko Oikawa",speed:1},{file:"tchaikovsky_nutcracker_act-1_2_march_(c)yogore.mid",title:"March (Nutcracker) - Tchaikovsky",speed:1},{file:"Hotline_Bling_MIDI_UPDATED_2016.mid",title:"Hotline Bling",speed:1}],ae={"n-text":{text:"",fontSize:10,width:80,height:1,horizontalAlign:"middle",verticalAlign:"middle"}};e.start=function(e,a){return I=e||!1,w=a.position||{x:0,y:0,z:0},y=a.rotation||{x:0,y:0,z:0},I?void r():void console.log("MidiPiano must be passed a scene! Exiting...")},e.update=function(){TWEEN.update()},window.AFRAME&&AFRAME.registerComponent("midi-piano",{schema:{position:{type:"vec3",default:"0 0 0"},rotation:{type:"vec3",default:"0 0 0"}},init:function(){e.start(this.el.object3D,this.data)},tick:function(){isInitilized&&e.update()}})}(MidiPiano,altspace);
!function(){function t(t){this.message=t}var e="undefined"!=typeof exports?exports:this,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";t.prototype=new Error,t.prototype.name="InvalidCharacterError",e.btoa||(e.btoa=function(e){for(var o,n,a=0,i=r,c="";e.charAt(0|a)||(i="=",a%1);c+=i.charAt(63&o>>8-a%1*8)){if(n=e.charCodeAt(a+=.75),n>255)throw new t("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");o=o<<8|n}return c}),e.atob||(e.atob=function(e){if(e=e.replace(/=+$/,""),e.length%4==1)throw new t("'atob' failed: The string to be decoded is not correctly encoded.");for(var o,n,a=0,i=0,c="";n=e.charAt(i++);~n&&(o=a%4?64*o+n:n,a++%4)?c+=String.fromCharCode(255&o>>(-2*a&6)):0)n=r.indexOf(n);return c})}();
var Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(e){var r=Math.ceil(3*e.length/4),t=new ArrayBuffer(r);return this.decode(e,t),t},decode:function(e,r){var t=this._keyStr.indexOf(e.charAt(e.length-1)),n=this._keyStr.indexOf(e.charAt(e.length-1)),a=Math.ceil(3*e.length/4);64==t&&a--,64==n&&a--;var i,h,c,f,d,y,A,s,k=0,l=0;for(i=r?new Uint8Array(r):new Uint8Array(a),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),k=0;k<a;k+=3)d=this._keyStr.indexOf(e.charAt(l++)),y=this._keyStr.indexOf(e.charAt(l++)),A=this._keyStr.indexOf(e.charAt(l++)),s=this._keyStr.indexOf(e.charAt(l++)),h=d<<2|y>>4,c=(15&y)<<4|A>>2,f=(3&A)<<6|s,i[k]=h,64!=A&&(i[k+1]=c),64!=s&&(i[k+2]=f);return i}};
"undefined"==typeof MIDI&&(MIDI={}),function(e){var t=e.util||(e.util={});if(t.request=function(t,s,n,o){"use strict";"string"==typeof t&&(t={url:t});var a=t.data,i=t.url,l=t.method||(t.data?"POST":"GET"),u=t.format,d=t.headers,p=t.responseType,f=t.withCredentials||!1,s=s||t.onsuccess,n=n||t.onerror,o=o||t.onprogress;if("undefined"!=typeof r&&e.loc.isLocalUrl(i))return void r.readFile(i,"utf8",function(e,t){e?n&&n(e):s&&s({responseText:t})});var c=new XMLHttpRequest;if(c.open(l,i,!0),d)for(var y in d)c.setRequestHeader(y,d[y]);else a&&c.setRequestHeader("Content-type","application/x-www-form-urlencoded");return"binary"===u&&c.overrideMimeType&&c.overrideMimeType("text/plain; charset=x-user-defined"),p&&(c.responseType=p),f&&(c.withCredentials="true"),n&&"onerror"in c&&(c.onerror=n),o&&c.upload&&"onprogress"in c.upload&&(a?c.upload.onprogress=function(e){o.call(c,e,event.loaded/event.total)}:c.addEventListener("progress",function(e){var t=0;if(e.lengthComputable)t=e.total;else if(c.totalBytes)t=c.totalBytes;else{var r=parseInt(c.getResponseHeader("Content-Length-Raw"));if(!isFinite(r))return;c.totalBytes=t=r}o.call(c,e,e.loaded/t)})),c.onreadystatechange=function(t){if(4===c.readyState)if(200===c.status||304===c.status||308===c.status||0===c.status&&e.client.cordova){if(s){var r;if("xml"===u)r=t.target.responseXML;else if("text"===u)r=t.target.responseText;else if("json"===u)try{r=JSON.parse(t.target.response)}catch(e){n&&n.call(c,t)}s.call(c,t,r)}}else n&&n.call(c,t)},c.send(a),c},"undefined"!=typeof module&&module.exports){var r=require("fs");XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest,module.exports=e.util.request}}(MIDI);
if("undefined"==typeof dom)var dom={};!function(){"use strict";dom.loadScript=function(){return this.loaded={},this.loading={},this},dom.loadScript.prototype.add=function(t){var r=this;"string"==typeof t&&(t={url:t});var o=t.urls;"undefined"==typeof o&&(o=[{url:t.url,verify:t.verify}]);var n=document.getElementsByTagName("head")[0],i=function(t,o){r.loaded[t.url]||o&&e(o)===!1||(r.loaded[t.url]=!0,r.loading[t.url]&&r.loading[t.url](),delete r.loading[t.url],t.onsuccess&&t.onsuccess(),"undefined"!=typeof f&&f())},s=!1,l=[],d=function(e){if("string"==typeof e&&(e={url:e,verify:t.verify}),/([\w\d.\[\]\'\"])$/.test(e.verify)){var o=e.test=e.verify;if("object"==typeof o)for(var d=0;d<o.length;d++)l.push(o[d]);else l.push(o)}if(!r.loaded[e.url]){var a=document.createElement("script");a.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||i(e)},a.onload=function(){i(e)},a.onerror=function(){if(s=!0,delete r.loading[e.url],"object"==typeof e.test)for(var t in e.test)u(e.test[t]);else u(e.test)},a.setAttribute("type","text/javascript"),a.setAttribute("src",e.url),n.appendChild(a),r.loading[e.url]=function(){}}},u=function(e){for(var t=[],r=0;r<l.length;r++)l[r]!==e&&t.push(l[r]);l=t},a=function(r){if(r)i(r,r.test);else for(var n=0;n<o.length;n++)i(o[n],o[n].test);for(var d=!0,n=0;n<l.length;n++)e(l[n])===!1&&(d=!1);!t.strictOrder&&d?s?t.error&&t.error():t.onsuccess&&t.onsuccess():setTimeout(function(){a(r)},10)};if(t.strictOrder){var c=-1,f=function(){if(c++,o[c]){var e=o[c],n=e.url;r.loading[n]?r.loading[n]=function(){e.onsuccess&&e.onsuccess(),f()}:r.loaded[n]?f():(d(e),a(e))}else s?t.error&&t.error():t.onsuccess&&t.onsuccess()};f()}else for(var c=0;c<o.length;c++)d(o[c]),a(o[c])},dom.loadScript=new dom.loadScript;var e=function(e,t){try{e=e.split('"').join("").split("'").join("").split("]").join("").split("[").join(".");for(var r=e.split("."),o=r.length,n=t||window,i=0;i<o;i++){var s=r[i];if(null==n[s])return!1;n=n[s]}return!0}catch(e){return!1}}}(),"undefined"!=typeof module&&module.exports&&(module.exports=dom.loadScript);
function Stream(r){function t(t){var n=r.substr(c,t);return c+=t,n}function n(){var t=(r.charCodeAt(c)<<24)+(r.charCodeAt(c+1)<<16)+(r.charCodeAt(c+2)<<8)+r.charCodeAt(c+3);return c+=4,t}function e(){var t=(r.charCodeAt(c)<<8)+r.charCodeAt(c+1);return c+=2,t}function a(t){var n=r.charCodeAt(c);return t&&n>127&&(n-=256),c+=1,n}function o(){return c>=r.length}function u(){for(var r=0;;){var t=a();if(!(128&t))return r+t;r+=127&t,r<<=7}}var c=0;return{eof:o,read:t,readInt32:n,readInt16:e,readInt8:a,readVarInt:u}}
function MidiFile(e){function t(e){var t=e.read(4),r=e.readInt32();return{id:t,length:r,data:e.read(r)}}function r(e){var t={};t.deltaTime=e.readVarInt();var r=e.readInt8();if(240==(240&r)){if(255==r){t.type="meta";var n=e.readInt8(),d=e.readVarInt();switch(n){case 0:if(t.subtype="sequenceNumber",2!=d)throw"Expected length for sequenceNumber event is 2, got "+d;return t.number=e.readInt16(),t;case 1:return t.subtype="text",t.text=e.read(d),t;case 2:return t.subtype="copyrightNotice",t.text=e.read(d),t;case 3:return t.subtype="trackName",t.text=e.read(d),t;case 4:return t.subtype="instrumentName",t.text=e.read(d),t;case 5:return t.subtype="lyrics",t.text=e.read(d),t;case 6:return t.subtype="marker",t.text=e.read(d),t;case 7:return t.subtype="cuePoint",t.text=e.read(d),t;case 32:if(t.subtype="midiChannelPrefix",1!=d)throw"Expected length for midiChannelPrefix event is 1, got "+d;return t.channel=e.readInt8(),t;case 47:if(t.subtype="endOfTrack",0!=d)throw"Expected length for endOfTrack event is 0, got "+d;return t;case 81:if(t.subtype="setTempo",3!=d)throw"Expected length for setTempo event is 3, got "+d;return t.microsecondsPerBeat=(e.readInt8()<<16)+(e.readInt8()<<8)+e.readInt8(),t;case 84:if(t.subtype="smpteOffset",5!=d)throw"Expected length for smpteOffset event is 5, got "+d;var s=e.readInt8();return t.frameRate={0:24,32:25,64:29,96:30}[96&s],t.hour=31&s,t.min=e.readInt8(),t.sec=e.readInt8(),t.frame=e.readInt8(),t.subframe=e.readInt8(),t;case 88:if(t.subtype="timeSignature",4!=d)throw"Expected length for timeSignature event is 4, got "+d;return t.numerator=e.readInt8(),t.denominator=Math.pow(2,e.readInt8()),t.metronome=e.readInt8(),t.thirtyseconds=e.readInt8(),t;case 89:if(t.subtype="keySignature",2!=d)throw"Expected length for keySignature event is 2, got "+d;return t.key=e.readInt8(!0),t.scale=e.readInt8(),t;case 127:return t.subtype="sequencerSpecific",t.data=e.read(d),t;default:return t.subtype="unknown",t.data=e.read(d),t}return t.data=e.read(d),t}if(240==r){t.type="sysEx";var d=e.readVarInt();return t.data=e.read(d),t}if(247==r){t.type="dividedSysEx";var d=e.readVarInt();return t.data=e.read(d),t}throw"Unrecognised MIDI event type byte: "+r}var u;0==(128&r)?(u=r,r=a):(u=e.readInt8(),a=r);var o=r>>4;switch(t.channel=15&r,t.type="channel",o){case 8:return t.subtype="noteOff",t.noteNumber=u,t.velocity=e.readInt8(),t;case 9:return t.noteNumber=u,t.velocity=e.readInt8(),0==t.velocity?t.subtype="noteOff":t.subtype="noteOn",t;case 10:return t.subtype="noteAftertouch",t.noteNumber=u,t.amount=e.readInt8(),t;case 11:return t.subtype="controller",t.controllerType=u,t.value=e.readInt8(),t;case 12:return t.subtype="programChange",t.programNumber=u,t;case 13:return t.subtype="channelAftertouch",t.amount=u,t;case 14:return t.subtype="pitchBend",t.value=u+(e.readInt8()<<7),t;default:throw"Unrecognised MIDI event type: "+o}}var a;stream=Stream(e);var n=t(stream);if("MThd"!=n.id||6!=n.length)throw"Bad .mid file - header not found";var d=Stream(n.data),s=d.readInt16(),u=d.readInt16(),o=d.readInt16();if(32768&o)throw"Expressing time division in SMTPE frames is not supported yet";ticksPerBeat=o;for(var i={formatType:s,trackCount:u,ticksPerBeat:ticksPerBeat},c=[],p=0;p<i.trackCount;p++){c[p]=[];var f=t(stream);if("MTrk"!=f.id)throw"Unexpected chunk - expected MTrk, got "+f.id;for(var y=Stream(f.data);!y.eof();){var m=r(y);c[p].push(m)}}return{header:i,tracks:c}}
function Replayer(t,e,n,r){function l(){for(var e=null,n=null,r=null,l=0;l<o.length;l++)null!=o[l].ticksToNextEvent&&(null==e||o[l].ticksToNextEvent<e)&&(e=o[l].ticksToNextEvent,n=l,r=o[l].nextEventIndex);if(null!=n){var c=t.tracks[n][r];t.tracks[n][r+1]?o[n].ticksToNextEvent+=t.tracks[n][r+1].deltaTime:o[n].ticksToNextEvent=null,o[n].nextEventIndex+=1;for(var l=0;l<o.length;l++)null!=o[l].ticksToNextEvent&&(o[l].ticksToNextEvent-=e);return{ticksToEvent:e,event:c,track:n}}return null}function c(){function t(){u||"meta"!=s.event.type||"setTempo"!=s.event.subtype||(v=6e7/s.event.microsecondsPerBeat);var t=0,n=0;s.ticksToEvent>0&&(t=s.ticksToEvent/a,n=t/(v/60));var r=1e3*n*e||0;k.push([s,r]),s=l()}if(s=l())for(;s;)t(!0)}for(var o=[],v=r?r:120,u=!!r,a=t.header.ticksPerBeat,i=0;i<t.tracks.length;i++)o[i]={nextEventIndex:0,ticksToNextEvent:t.tracks[i].length?t.tracks[i][0].deltaTime:null};var s,k=[];return c(),{getData:function(){return clone(k)}}}var clone=function(t){if("object"!=typeof t)return t;if(null==t)return t;var e="number"==typeof t.length?[]:{};for(var n in t)e[n]=clone(t[n]);return e};
if("undefined"==typeof MIDI&&(MIDI={}),function(e){"use strict";var n={},t=0;e.audioDetect=function(e){if(navigator.requestMIDIAccess){var r=Function.prototype.toString.call(navigator.requestMIDIAccess).indexOf("[native code]");if(r)n.webmidi=!0;else for(var o=0;navigator.plugins.length>o;o++){var a=navigator.plugins[o];a.name.indexOf("Jazz-Plugin")>=0&&(n.webmidi=!0)}}if("undefined"==typeof Audio)return e({});n.audiotag=!0,(window.AudioContext||window.webkitAudioContext)&&(n.webaudio=!0);var i=new Audio;if("undefined"==typeof i.canPlayType)return e(n);var s=i.canPlayType('audio/ogg; codecs="vorbis"');s="probably"===s||"maybe"===s;var u=i.canPlayType("audio/mpeg");if(u="probably"===u||"maybe"===u,!s&&!u)return void e(n);var c=(new Date).getTime(),l=window.setInterval(function(){var r=(new Date).getTime(),o=r-c>5e3;t&&!o||(window.clearInterval(l),e(n))},1)}}(MIDI),function(e){"use strict";e.GM=function(e){var n=function(e){return e.replace(/[^a-z0-9 ]/gi,"").replace(/[ ]/g,"_").toLowerCase()},t={byName:{},byId:{},byCategory:{}};for(var r in e)for(var o=e[r],a=0,i=o.length;a<i;a++){var s=o[a];if(s){var u=parseInt(s.substr(0,s.indexOf(" ")),10);s=s.replace(u+" ",""),t.byId[--u]=t.byName[n(s)]=t.byCategory[n(r)]={id:n(s),instrument:s,number:u,category:r}}}return t}({Piano:["1 Acoustic Grand Piano","2 Bright Acoustic Piano","3 Electric Grand Piano","4 Honky-tonk Piano","5 Electric Piano 1","6 Electric Piano 2","7 Harpsichord","8 Clavinet"],"Chromatic Percussion":["9 Celesta","10 Glockenspiel","11 Music Box","12 Vibraphone","13 Marimba","14 Xylophone","15 Tubular Bells","16 Dulcimer"],Organ:["17 Drawbar Organ","18 Percussive Organ","19 Rock Organ","20 Church Organ","21 Reed Organ","22 Accordion","23 Harmonica","24 Tango Accordion"],Guitar:["25 Acoustic Guitar (nylon)","26 Acoustic Guitar (steel)","27 Electric Guitar (jazz)","28 Electric Guitar (clean)","29 Electric Guitar (muted)","30 Overdriven Guitar","31 Distortion Guitar","32 Guitar Harmonics"],Bass:["33 Acoustic Bass","34 Electric Bass (finger)","35 Electric Bass (pick)","36 Fretless Bass","37 Slap Bass 1","38 Slap Bass 2","39 Synth Bass 1","40 Synth Bass 2"],Strings:["41 Violin","42 Viola","43 Cello","44 Contrabass","45 Tremolo Strings","46 Pizzicato Strings","47 Orchestral Harp","48 Timpani"],Ensemble:["49 String Ensemble 1","50 String Ensemble 2","51 Synth Strings 1","52 Synth Strings 2","53 Choir Aahs","54 Voice Oohs","55 Synth Choir","56 Orchestra Hit"],Brass:["57 Trumpet","58 Trombone","59 Tuba","60 Muted Trumpet","61 French Horn","62 Brass Section","63 Synth Brass 1","64 Synth Brass 2"],Reed:["65 Soprano Sax","66 Alto Sax","67 Tenor Sax","68 Baritone Sax","69 Oboe","70 English Horn","71 Bassoon","72 Clarinet"],Pipe:["73 Piccolo","74 Flute","75 Recorder","76 Pan Flute","77 Blown Bottle","78 Shakuhachi","79 Whistle","80 Ocarina"],"Synth Lead":["81 Lead 1 (square)","82 Lead 2 (sawtooth)","83 Lead 3 (calliope)","84 Lead 4 (chiff)","85 Lead 5 (charang)","86 Lead 6 (voice)","87 Lead 7 (fifths)","88 Lead 8 (bass + lead)"],"Synth Pad":["89 Pad 1 (new age)","90 Pad 2 (warm)","91 Pad 3 (polysynth)","92 Pad 4 (choir)","93 Pad 5 (bowed)","94 Pad 6 (metallic)","95 Pad 7 (halo)","96 Pad 8 (sweep)"],"Synth Effects":["97 FX 1 (rain)","98 FX 2 (soundtrack)","99 FX 3 (crystal)","100 FX 4 (atmosphere)","101 FX 5 (brightness)","102 FX 6 (goblins)","103 FX 7 (echoes)","104 FX 8 (sci-fi)"],Ethnic:["105 Sitar","106 Banjo","107 Shamisen","108 Koto","109 Kalimba","110 Bagpipe","111 Fiddle","112 Shanai"],Percussive:["113 Tinkle Bell","114 Agogo","115 Steel Drums","116 Woodblock","117 Taiko Drum","118 Melodic Tom","119 Synth Drum"],"Sound effects":["120 Reverse Cymbal","121 Guitar Fret Noise","122 Breath Noise","123 Seashore","124 Bird Tweet","125 Telephone Ring","126 Helicopter","127 Applause","128 Gunshot"]}),e.getInstrument=function(n){var t=e.channels[n];return t&&t.instrument},e.setInstrument=function(n,t,r){var o=e.channels[n];return r?setTimeout(function(){o.instrument=t},r):void(o.instrument=t)},e.getMono=function(n){var t=e.channels[n];return t&&t.mono},e.setMono=function(n,t,r){var o=e.channels[n];return r?setTimeout(function(){o.mono=t},r):void(o.mono=t)},e.getOmni=function(n){var t=e.channels[n];return t&&t.omni},e.setOmni=function(n,t){var r=e.channels[n];return delay?setTimeout(function(){r.omni=t},delay):void(r.omni=t)},e.getSolo=function(n){var t=e.channels[n];return t&&t.solo},e.setSolo=function(n,t){var r=e.channels[n];return delay?setTimeout(function(){r.solo=t},delay):void(r.solo=t)},e.channels=function(){for(var e={},n=0;n<16;n++)e[n]={instrument:n,pitchBend:0,mute:!1,mono:!1,omni:!1,solo:!1};return e}(),e.keyToNote={},e.noteToKey={},function(){for(var n=21,t=108,r=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],o=n;o<=t;o++){var a=(o-12)/12>>0,i=r[o%12]+a;e.keyToNote[i]=o,e.noteToKey[o]=i}}()}(MIDI),"undefined"==typeof MIDI&&(MIDI={}),MIDI.Soundfont=MIDI.Soundfont||{},MIDI.Player=MIDI.Player||{},function(e){"use strict";e.DEBUG=!0,e.USE_XHR=!0,e.soundfontUrl="./soundfont/",e.loadPlugin=function(t){"function"==typeof t&&(t={onsuccess:t}),e.soundfontUrl=t.soundfontUrl||e.soundfontUrl,e.audioDetect(function(r){var o=window.location.hash,a="";if(r[t.api]?a=t.api:r[o.substr(1)]?a=o.substr(1):(window.AudioContext||window.webkitAudioContext)&&(a="webaudio"),console.log(a),n[a]){if(t.targetFormat)var i=t.targetFormat;else var i=r["audio/ogg"]?"ogg":"mp3";e.__api=a,e.__audioFormat=i,e.supports=r,e.loadResource(t)}})},e.loadResource=function(t){var r=t.instruments||t.instrument||"acoustic_grand_piano";"object"!=typeof r&&(r=r||0===r?[r]:[]);for(var o=0;o<r.length;o++){var a=r[o];a===+a&&e.GM.byId[a]&&(r[o]=e.GM.byId[a].id)}t.format=e.__audioFormat,t.instruments=r,n[e.__api](t)};var n={webaudio:function(e){t(e,"WebAudio")}},t=function(n,t){for(var o=n.format,a=n.instruments,i=n.onprogress,s=n.onerror,u=a.length,c=u,l=function(){--c||(i&&i("load",1),e[t].connect(n))},d=0;d<u;d++){var f=a[d];MIDI.Soundfont[f]?l():r(a[d],o,function(e,n){var t=n/u,r=(u-c)/u;i&&i("load",t+r,f)},function(){l()},s)}},r=function(n,t,r,o,a){var i=e.soundfontUrl+n+"-"+t+".js";e.USE_XHR?e.util.request({url:i,format:"text",onerror:a,onprogress:r,onsuccess:function(e,n){var t=document.createElement("script");t.language="javascript",t.type="text/javascript",t.text=n,document.body.appendChild(t),o()}}):dom.loadScript.add({url:i,verify:'MIDI.Soundfont["'+n+'"]',onerror:a,onsuccess:function(){o()}})};e.setDefaultPlugin=function(n){for(var t in n)e[t]=n[t]}}(MIDI),"undefined"==typeof MIDI&&(MIDI={}),"undefined"==typeof MIDI.Player&&(MIDI.Player={}),function(){"use strict";var e=MIDI.Player;e.currentTime=0,e.endTime=0,e.restart=0,e.playing=!1,e.timeWarp=1,e.startDelay=0,e.BPM=120,e.start=e.resume=function(n){e.currentTime<-1&&(e.currentTime=-1),d(e.currentTime,null,n)},e.pause=function(){var n=e.restart;f(),e.restart=n},e.stop=function(){f(),e.restart=0,e.currentTime=0},e.addListener=function(e){i=e},e.removeListener=function(){i=void 0},e.clearAnimation=function(){e.animationFrameId&&cancelAnimationFrame(e.animationFrameId)},e.setAnimation=function(n){var t=0,r=0,o=0;e.clearAnimation();var i=function(){if(e.animationFrameId=requestAnimationFrame(i),0!==e.endTime){e.playing?(t=o===e.currentTime?r-Date.now():0,t=0===e.currentTime?0:e.currentTime-t,o!==e.currentTime&&(r=Date.now(),o=e.currentTime)):t=e.currentTime;var s=e.endTime,u=t/1e3,c=u/60,l=u-60*c,d=60*c+l,f=s/1e3;f-d<-1||n({now:d,end:f,events:a})}};requestAnimationFrame(i)},e.loadMidiFile=function(n,t,r){try{e.replayer=new Replayer(MidiFile(e.currentData),e.timeWarp,null,e.BPM),e.data=e.replayer.getData(),e.endTime=c(),MIDI.loadPlugin({onsuccess:n,onprogress:t,onerror:r})}catch(e){r&&r(e)}},e.loadFile=function(n,t,r,o){if(e.stop(),n.indexOf("base64,")!==-1){var a=window.atob(n.split(",")[1]);e.currentData=a,e.loadMidiFile(t,r,o)}else{var i=new XMLHttpRequest;i.open("GET",n),i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){for(var n=this.responseText||"",a=[],i=n.length,s=String.fromCharCode,u=0;u<i;u++)a[u]=s(255&n.charCodeAt(u));var c=a.join("");e.currentData=c,e.loadMidiFile(t,r,o)}else o&&o("Unable to load MIDI file")},i.send()}},e.getFileInstruments=function(){for(var n={},t={},r=0;r<e.data.length;r++){var o=e.data[r][0].event;if("channel"===o.type){var a=o.channel;switch(o.subtype){case"controller":break;case"programChange":t[a]=o.programNumber;break;case"noteOn":var i=t[a],s=MIDI.GM.byId[isFinite(i)?i:a];n[s.id]=!0}}}var u=[];for(var c in n)u.push(c);return u};var n,t,r=[],o=0,a={},i=void 0,s=function(t,o,s,u,c,l,f){return setTimeout(function(){var u={channel:t,note:o,now:s,end:e.endTime,message:c,velocity:l};128===c?delete a[o]:a[o]=u,i&&i(u),e.currentTime=s,r.shift(),r.length<1e3?d(n,!0):e.currentTime===n&&n<e.endTime&&d(n,!0)},s-u)},u=function(){return"webaudio"===MIDI.api?MIDI.WebAudio.getContext():(e.ctx={currentTime:0},e.ctx)},c=function(){for(var n=e.data,t=n.length,r=.5,o=0;o<t;o++)r+=n[o][1];return r},l=function(){return window.performance&&window.performance.now?window.performance.now():Date.now()},d=function(a,i,d){if(e.replayer){i||("undefined"==typeof a&&(a=e.restart),e.playing&&f(),e.playing=!0,e.data=e.replayer.getData(),e.endTime=c());var p,m=0,v=0,g=e.data,h=u(),y=g.length;n=.5;var I=(r[0]&&r[0].interval||0,a-e.currentTime);if("webaudio"!==MIDI.api){var T=l();t=t||T,h.currentTime=(T-t)/1e3}o=h.currentTime;for(var b=0;b<y&&v<100;b++){var w=g[b];if((n+=w[1])<=a)m=n;else{a=n-m;var M=w[0].event;if("channel"===M.type){var D=M.channel,S=MIDI.channels[D],B=h.currentTime+(a+I+e.startDelay)/1e3,A=n-m+e.startDelay;switch(M.subtype){case"controller":MIDI.setController(D,M.controllerType,M.value,B);break;case"programChange":MIDI.programChange(D,M.programNumber,B);break;case"pitchBend":MIDI.pitchBend(D,M.value,B);break;case"noteOn":if(S.mute)break;p=M.noteNumber-(e.MIDIOffset||0),r.push({event:M,time:A,source:MIDI.noteOn(D,M.noteNumber,M.velocity,B),interval:s(D,p,n+e.startDelay,m-I,144,M.velocity)}),v++;break;case"noteOff":if(S.mute)break;p=M.noteNumber-(e.MIDIOffset||0),r.push({event:M,time:A,source:MIDI.noteOff(D,M.noteNumber,B),interval:s(D,p,n,m-I,128,0)})}}}}d&&d(r)}},f=function(){var n=u();for(e.playing=!1,e.restart+=1e3*(n.currentTime-o);r.length;){var t=r.pop();window.clearInterval(t.interval),t.source&&("number"==typeof t.source?window.clearTimeout(t.source):t.source.disconnect(0))}for(var s in a){var t=a[s];144===a[s].message&&i&&i({channel:t.channel,note:t.note,now:t.now,end:t.end,message:128,velocity:t.velocity})}a={}}}(),function(e){"use strict";!function(){function n(e,n,t){if(o){var a=new Audio;a.src=e,a.controls=!1,a.autoplay=!1,a.preload=!1,a.addEventListener("canplay",function(){n&&n(a)}),a.addEventListener("error",function(e){t&&t(e)}),document.body.appendChild(a)}else if(0===e.indexOf("data:audio")){var i=e.split(",")[1],s=Base64Binary.decodeArrayBuffer(i);r.decodeAudioData(s,n,t),console.log("Base64 string")}else{var u=new XMLHttpRequest;u.open("GET",e,!0),u.responseType="arraybuffer",u.onload=function(){r.decodeAudioData(u.response,n,t)},u.send(),console.log("XMLHTTP Buffer")}}function t(){return new(window.AudioContext||window.webkitAudioContext)}var r,o=!1,a=e.WebAudio={api:"webaudio"},i={},s={},u=127,c={};a.audioBuffers=c,a.send=function(e,n){},a.setController=function(e,n,t,r){},a.setVolume=function(e,n,t){if(t)setTimeout(function(){u=n},1e3*t);else{u=n;var r=u/127;for(var o in a.audioBuffers)a.audioBuffers[o].gain=Math.min(1,Math.max(-1,r))}},a.programChange=function(n,t,r){var o=e.channels[n];o.instrument=t},a.pitchBend=function(n,t,r){var o=e.channels[n];o.pitchBend=t},a.noteOn=function(n,t,a,l){l=l||0;var d=e.channels[n],f=d.instrument,p=f+""+t,m=c[p];if(m){if(l<r.currentTime&&(l+=r.currentTime),o)var v=r.createMediaElementSource(m);else{var v=r.createBufferSource();v.buffer=m}if(s){var g=v;for(var h in s)g.connect(s[h].input),g=s[h]}var y=a/127*(u/127)*2-1;if(v.connect(r.destination),v.playbackRate.value=1,v.gainNode=r.createGain(),v.gainNode.connect(r.destination),v.gainNode.gain.value=Math.min(1,Math.max(-1,y)),v.connect(v.gainNode),o){if(l)return setTimeout(function(){m.currentTime=0,m.play()},1e3*l);m.currentTime=0,m.play()}else v.start(l||0);return i[n+""+t]=v,v}},a.noteOff=function(n,t,a){a=a||0;var s=e.channels[n],u=s.instrument,l=u+""+t,d=c[l];if(d){a<r.currentTime&&(a+=r.currentTime);var f=i[n+""+t];if(f){if(f.gainNode){var p=f.gainNode.gain;p.linearRampToValueAtTime(p.value,a),p.linearRampToValueAtTime(-1,a+.3)}return o?a?setTimeout(function(){d.pause()},1e3*a):d.pause():f.noteOff?f.noteOff(a+.5):f.stop(a+.5),delete i[n+""+t],f}}},a.chordOn=function(e,n,t,r){for(var o,i={},s=0,u=n.length;s<u;s++)i[o=n[s]]=a.noteOn(e,o,t,r);return i},a.chordOff=function(e,n,t){for(var r,o={},i=0,s=n.length;i<s;i++)o[r=n[i]]=a.noteOff(e,r,t);return o},a.stopAllNotes=function(){for(var e in i){var n=0;n<r.currentTime&&(n+=r.currentTime);var t=i[e];t.gain.linearRampToValueAtTime(1,n),t.gain.linearRampToValueAtTime(0,n+.3),t.noteOff?t.noteOff(n+.3):t.stop(n+.3),delete i[e]}},a.setEffects=function(e){if(!r.tunajs)return console.log("Effects module not installed.");for(var n=0;n<e.length;n++){var t=e[n],o=new r.tunajs[t.type](t);o.connect(r.destination),s[t.type]=o}},a.connect=function(n){e.setDefaultPlugin(a),a.setContext(r||t(),n.onsuccess)},a.getContext=function(){return r},a.setContext=function(t,o,a,i){r=t,"undefined"==typeof Tuna||r.tunajs||(r.tunajs=new Tuna(r));var s=[],u=e.keyToNote;for(var l in u)s.push(l);var d=function(e){for(var n in p)if(p[n])return;o&&(o(),o=null)},f=function(t,r,o,a){var i=t[a];i&&(p[r]++,n(i,function(n){n.id=a;var o=e.keyToNote[a];if(c[r+""+o]=n,0===--p[r]){t.isLoaded=!0,d(m)}},function(e){}))},p={};for(var m in e.Soundfont){var v=e.Soundfont[m];if(!v.isLoaded){var g=e.GM.byName[m],h=g.number;p[h]=0;for(var y=0;y<s.length;y++){var l=s[y];f(v,h,y,l)}}}setTimeout(d,1)}}()}(MIDI),function(e){"use strict";var n=null,t=null,r=e.WebMIDI={api:"webmidi"};r.send=function(e,n){t.send(e,1e3*n)},r.setController=function(e,n,r,o){t.send([e,n,r],1e3*o)},r.setVolume=function(e,n,r){t.send([176+e,7,n],1e3*r)},r.programChange=function(e,n,r){t.send([192+e,n],1e3*r)},r.pitchBend=function(e,n,r){t.send([224+e,n],1e3*r)},r.noteOn=function(e,n,r,o){t.send([144+e,n,r],1e3*o)},r.noteOff=function(e,n,r){t.send([128+e,n,0],1e3*r)},r.chordOn=function(e,n,r,o){for(var a=0;a<n.length;a++){var i=n[a];t.send([144+e,i,r],1e3*o)}},r.chordOff=function(e,n,r){for(var o=0;o<n.length;o++){var a=n[o];t.send([128+e,a,0],1e3*r)}},r.stopAllNotes=function(){t.cancel();for(var e=0;e<16;e++)t.send([176+e,123,0])},r.connect=function(o){e.setDefaultPlugin(r);var a=function(n){if(window.AudioContext)o.api="webaudio";else{if(!window.Audio)return;o.api="audiotag"}e.loadPlugin(o)};navigator.requestMIDIAccess().then(function(e){n=e;var r=n.outputs;t="function"==typeof r?r()[0]:r[0],void 0===t?a():o.onsuccess&&o.onsuccess()},a)}}(MIDI),"undefined"==typeof MIDI&&(MIDI={}),function(e){var n=e.util||(e.util={});if(n.request=function(n,r,o,a){"use strict";"string"==typeof n&&(n={url:n});var i=n.data,s=n.url,u=n.method||(n.data?"POST":"GET"),c=n.format,l=n.headers,d=n.responseType,f=n.withCredentials||!1,r=r||n.onsuccess,o=o||n.onerror,a=a||n.onprogress;if("undefined"!=typeof t&&e.loc.isLocalUrl(s))return void t.readFile(s,"utf8",function(e,n){e?o&&o(e):r&&r({responseText:n})});var p=new XMLHttpRequest;if(p.open(u,s,!0),l)for(var m in l)p.setRequestHeader(m,l[m]);else i&&p.setRequestHeader("Content-type","application/x-www-form-urlencoded");return"binary"===c&&p.overrideMimeType&&p.overrideMimeType("text/plain; charset=x-user-defined"),d&&(p.responseType=d),f&&(p.withCredentials="true"),o&&"onerror"in p&&(p.onerror=o),a&&p.upload&&"onprogress"in p.upload&&(i?p.upload.onprogress=function(e){a.call(p,e,event.loaded/event.total)}:p.addEventListener("progress",function(e){var n=0;if(e.lengthComputable)n=e.total;else if(p.totalBytes)n=p.totalBytes;else{var t=parseInt(p.getResponseHeader("Content-Length-Raw"));if(!isFinite(t))return;p.totalBytes=n=t}a.call(p,e,e.loaded/n)})),p.onreadystatechange=function(e){if(4===p.readyState)if(200===p.status||304===p.status||308===p.status){if(r){var n;if("xml"===c)n=e.target.responseXML;else if("text"===c)n=e.target.responseText;else if("json"===c)try{n=JSON.parse(e.target.response)}catch(n){o&&o.call(p,e)}r.call(p,e,n)}}else o&&o.call(p,e)},p.send(i),p},"undefined"!=typeof module&&module.exports){var t=require("fs");XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest,module.exports=e.util.request}}(MIDI),"undefined"==typeof dom)var dom={};!function(){"use strict";dom.loadScript=function(){return this.loaded={},this.loading={},this},dom.loadScript.prototype.add=function(n){var t=this;"string"==typeof n&&(n={url:n});var r=n.urls;"undefined"==typeof r&&(r=[{url:n.url,verify:n.verify}]);var o=document.getElementsByTagName("head")[0],a=function(n,r){t.loaded[n.url]||r&&e(r)===!1||(t.loaded[n.url]=!0,t.loading[n.url]&&t.loading[n.url](),delete t.loading[n.url],n.onsuccess&&n.onsuccess(),"undefined"!=typeof f&&f())},i=!1,s=[],u=function(e){if("string"==typeof e&&(e={url:e,verify:n.verify}),/([\w\d.\[\]\'\"])$/.test(e.verify)){var r=e.test=e.verify;if("object"==typeof r)for(var u=0;u<r.length;u++)s.push(r[u]);else s.push(r)}if(!t.loaded[e.url]){var l=document.createElement("script");l.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||a(e)},l.onload=function(){a(e)},l.onerror=function(){if(i=!0,delete t.loading[e.url],"object"==typeof e.test)for(var n in e.test)c(e.test[n]);else c(e.test)},l.setAttribute("type","text/javascript"),l.setAttribute("src",e.url),o.appendChild(l),t.loading[e.url]=function(){}}},c=function(e){for(var n=[],t=0;t<s.length;t++)s[t]!==e&&n.push(s[t]);s=n},l=function(t){if(t)a(t,t.test);else for(var o=0;o<r.length;o++)a(r[o],r[o].test);for(var u=!0,o=0;o<s.length;o++)e(s[o])===!1&&(u=!1);!n.strictOrder&&u?i?n.error&&n.error():n.onsuccess&&n.onsuccess():setTimeout(function(){l(t)},10)};if(n.strictOrder){var d=-1,f=function(){if(d++,r[d]){var e=r[d],o=e.url;t.loading[o]?t.loading[o]=function(){e.onsuccess&&e.onsuccess(),f()}:t.loaded[o]?f():(u(e),l(e))}else i?n.error&&n.error():n.onsuccess&&n.onsuccess()};f()}else for(var d=0;d<r.length;d++)u(r[d]),l(r[d])},dom.loadScript=new dom.loadScript;var e=function(e,n){try{e=e.split('"').join("").split("'").join("").split("]").join("").split("[").join(".");for(var t=e.split("."),r=t.length,o=n||window,a=0;a<r;a++){var i=t[a];if(null==o[i])return!1;o=o[i]}return!0}catch(e){return!1}}}(),"undefined"!=typeof module&&module.exports&&(module.exports=dom.loadScript);
!function(){if("performance"in window==!1&&(window.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in window.performance==!1){var n=window.performance.timing&&window.performance.timing.navigationStart?window.performance.timing.navigationStart:Date.now();window.performance.now=function(){return Date.now()-n}}}();var TWEEN=TWEEN||function(){var n=[];return{getAll:function(){return n},removeAll:function(){n=[]},add:function(t){n.push(t)},remove:function(t){var r=n.indexOf(t);r!==-1&&n.splice(r,1)},update:function(t){if(0===n.length)return!1;var r=0;for(t=void 0!==t?t:window.performance.now();r<n.length;)n[r].update(t)?r++:n.splice(r,1);return!0}}}();TWEEN.Tween=function(n){var t=n,r={},i={},o={},u=1e3,e=0,a=!1,f=!1,c=!1,s=0,h=null,l=TWEEN.Easing.Linear.None,p=TWEEN.Interpolation.Linear,E=[],w=null,v=!1,d=null,I=null,M=null;for(var m in n)r[m]=parseFloat(n[m],10);this.to=function(n,t){return void 0!==t&&(u=t),i=n,this},this.start=function(n){TWEEN.add(this),f=!0,v=!1,h=void 0!==n?n:window.performance.now(),h+=s;for(var u in i){if(i[u]instanceof Array){if(0===i[u].length)continue;i[u]=[t[u]].concat(i[u])}void 0!==r[u]&&(r[u]=t[u],r[u]instanceof Array==!1&&(r[u]*=1),o[u]=r[u]||0)}return this},this.stop=function(){return f?(TWEEN.remove(this),f=!1,null!==M&&M.call(t),this.stopChainedTweens(),this):this},this.stopChainedTweens=function(){for(var n=0,t=E.length;n<t;n++)E[n].stop()},this.delay=function(n){return s=n,this},this.repeat=function(n){return e=n,this},this.yoyo=function(n){return a=n,this},this.easing=function(n){return l=n,this},this.interpolation=function(n){return p=n,this},this.chain=function(){return E=arguments,this},this.onStart=function(n){return w=n,this},this.onUpdate=function(n){return d=n,this},this.onComplete=function(n){return I=n,this},this.onStop=function(n){return M=n,this},this.update=function(n){var f,M,m;if(n<h)return!0;v===!1&&(null!==w&&w.call(t),v=!0),M=(n-h)/u,M=M>1?1:M,m=l(M);for(f in i)if(void 0!==r[f]){var T=r[f]||0,g=i[f];g instanceof Array?t[f]=p(g,m):("string"==typeof g&&(g=g.startsWith("+")||g.startsWith("-")?T+parseFloat(g,10):parseFloat(g,10)),"number"==typeof g&&(t[f]=T+(g-T)*m))}if(null!==d&&d.call(t,m),1===M){if(e>0){isFinite(e)&&e--;for(f in o){if("string"==typeof i[f]&&(o[f]=o[f]+parseFloat(i[f],10)),a){var O=o[f];o[f]=i[f],i[f]=O}r[f]=o[f]}return a&&(c=!c),h=n+s,!0}null!==I&&I.call(t);for(var N=0,W=E.length;N<W;N++)E[N].start(h+u);return!1}return!0}},TWEEN.Easing={Linear:{None:function(n){return n}},Quadratic:{In:function(n){return n*n},Out:function(n){return n*(2-n)},InOut:function(n){return(n*=2)<1?.5*n*n:-.5*(--n*(n-2)-1)}},Cubic:{In:function(n){return n*n*n},Out:function(n){return--n*n*n+1},InOut:function(n){return(n*=2)<1?.5*n*n*n:.5*((n-=2)*n*n+2)}},Quartic:{In:function(n){return n*n*n*n},Out:function(n){return 1- --n*n*n*n},InOut:function(n){return(n*=2)<1?.5*n*n*n*n:-.5*((n-=2)*n*n*n-2)}},Quintic:{In:function(n){return n*n*n*n*n},Out:function(n){return--n*n*n*n*n+1},InOut:function(n){return(n*=2)<1?.5*n*n*n*n*n:.5*((n-=2)*n*n*n*n+2)}},Sinusoidal:{In:function(n){return 1-Math.cos(n*Math.PI/2)},Out:function(n){return Math.sin(n*Math.PI/2)},InOut:function(n){return.5*(1-Math.cos(Math.PI*n))}},Exponential:{In:function(n){return 0===n?0:Math.pow(1024,n-1)},Out:function(n){return 1===n?1:1-Math.pow(2,-10*n)},InOut:function(n){return 0===n?0:1===n?1:(n*=2)<1?.5*Math.pow(1024,n-1):.5*(-Math.pow(2,-10*(n-1))+2)}},Circular:{In:function(n){return 1-Math.sqrt(1-n*n)},Out:function(n){return Math.sqrt(1- --n*n)},InOut:function(n){return(n*=2)<1?-.5*(Math.sqrt(1-n*n)-1):.5*(Math.sqrt(1-(n-=2)*n)+1)}},Elastic:{In:function(n){var t,r=.1,i=.4;return 0===n?0:1===n?1:(!r||r<1?(r=1,t=i/4):t=i*Math.asin(1/r)/(2*Math.PI),-(r*Math.pow(2,10*(n-=1))*Math.sin((n-t)*(2*Math.PI)/i)))},Out:function(n){var t,r=.1,i=.4;return 0===n?0:1===n?1:(!r||r<1?(r=1,t=i/4):t=i*Math.asin(1/r)/(2*Math.PI),r*Math.pow(2,-10*n)*Math.sin((n-t)*(2*Math.PI)/i)+1)},InOut:function(n){var t,r=.1,i=.4;return 0===n?0:1===n?1:(!r||r<1?(r=1,t=i/4):t=i*Math.asin(1/r)/(2*Math.PI),(n*=2)<1?-.5*(r*Math.pow(2,10*(n-=1))*Math.sin((n-t)*(2*Math.PI)/i)):r*Math.pow(2,-10*(n-=1))*Math.sin((n-t)*(2*Math.PI)/i)*.5+1)}},Back:{In:function(n){var t=1.70158;return n*n*((t+1)*n-t)},Out:function(n){var t=1.70158;return--n*n*((t+1)*n+t)+1},InOut:function(n){var t=2.5949095;return(n*=2)<1?.5*(n*n*((t+1)*n-t)):.5*((n-=2)*n*((t+1)*n+t)+2)}},Bounce:{In:function(n){return 1-TWEEN.Easing.Bounce.Out(1-n)},Out:function(n){return n<1/2.75?7.5625*n*n:n<2/2.75?7.5625*(n-=1.5/2.75)*n+.75:n<2.5/2.75?7.5625*(n-=2.25/2.75)*n+.9375:7.5625*(n-=2.625/2.75)*n+.984375},InOut:function(n){return n<.5?.5*TWEEN.Easing.Bounce.In(2*n):.5*TWEEN.Easing.Bounce.Out(2*n-1)+.5}}},TWEEN.Interpolation={Linear:function(n,t){var r=n.length-1,i=r*t,o=Math.floor(i),u=TWEEN.Interpolation.Utils.Linear;return t<0?u(n[0],n[1],i):t>1?u(n[r],n[r-1],r-i):u(n[o],n[o+1>r?r:o+1],i-o)},Bezier:function(n,t){for(var r=0,i=n.length-1,o=Math.pow,u=TWEEN.Interpolation.Utils.Bernstein,e=0;e<=i;e++)r+=o(1-t,i-e)*o(t,e)*n[e]*u(i,e);return r},CatmullRom:function(n,t){var r=n.length-1,i=r*t,o=Math.floor(i),u=TWEEN.Interpolation.Utils.CatmullRom;return n[0]===n[r]?(t<0&&(o=Math.floor(i=r*(1+t))),u(n[(o-1+r)%r],n[o],n[(o+1)%r],n[(o+2)%r],i-o)):t<0?n[0]-(u(n[0],n[0],n[1],n[1],-i)-n[0]):t>1?n[r]-(u(n[r],n[r],n[r-1],n[r-1],i-r)-n[r]):u(n[o?o-1:0],n[o],n[r<o+1?r:o+1],n[r<o+2?r:o+2],i-o)},Utils:{Linear:function(n,t,r){return(t-n)*r+n},Bernstein:function(n,t){var r=TWEEN.Interpolation.Utils.Factorial;return r(n)/r(t)/r(n-t)},Factorial:function(){var n=[1];return function(t){var r=1;if(n[t])return n[t];for(var i=t;i>1;i--)r*=i;return n[t]=r,r}}(),CatmullRom:function(n,t,r,i,o){var u=.5*(r-n),e=.5*(i-t),a=o*o,f=o*a;return(2*t-2*r+u+e)*f+(-3*t+3*r-2*u-e)*a+u*o+t}}},function(n){"function"==typeof define&&define.amd?define([],function(){return TWEEN}):"undefined"!=typeof module&&"object"==typeof exports?module.exports=TWEEN:void 0!==n&&(n.TWEEN=TWEEN)}(this);